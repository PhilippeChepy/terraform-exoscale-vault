# TL;DR

This repository implements a Vault cluster, setup in Exoscale cloud.
This module can be easily ported to other cloud providers as long as they allow to build and use custom OS templates.

Related repositories:
- [Packer templates](https://github.com/PhilippeChepy/packer-exoscale): contains packer definitions to build images for use by this module
- [Example cluster](https://github.com/PhilippeChepy/kubernetes-exoscale-demo): an example of a deployment involving this module and a Kubernetes cluster

# Missing parts

This repository doesn't implement important things that are required before using it in production:
- Backups: `vault` snapshots backups should be properly set.
- TLS certificates lifecycle: currently they are automatically generated by Terraform (with 1 year lifetime), but renewal is not tested at all!
In the future, automatic TLS management will be probably implemented.
- Monitoring: a very important task that can be implemented with Prometheus

# Module

<!-- BEGIN_TF_DOCS -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_exoscale"></a> [exoscale](#requirement\_exoscale) (>=0.31.1)

## Providers

The following providers are used by this module:

- <a name="provider_exoscale"></a> [exoscale](#provider\_exoscale) (>=0.31.1)

## Modules

The following Modules are called:

### <a name="module_ca_certificates"></a> [ca\_certificates](#module\_ca\_certificates)

Source: git@github.com:PhilippeChepy/terraform-tls-root-ca.git

Version:

### <a name="module_peer_certificate"></a> [peer\_certificate](#module\_peer\_certificate)

Source: git@github.com:PhilippeChepy/terraform-tls-certificate.git

Version:

### <a name="module_server_certificate"></a> [server\_certificate](#module\_server\_certificate)

Source: git@github.com:PhilippeChepy/terraform-tls-certificate.git

Version:

### <a name="module_vault_service"></a> [vault\_service](#module\_vault\_service)

Source: git@github.com:PhilippeChepy/terraform-initial-provisioning.git

Version:

## Resources

The following resources are used by this module:

- [exoscale_anti_affinity_group.cluster](https://registry.terraform.io/providers/exoscale/exoscale/latest/docs/resources/anti_affinity_group) (resource)
- [exoscale_compute_instance.peer](https://registry.terraform.io/providers/exoscale/exoscale/latest/docs/resources/compute_instance) (resource)
- [exoscale_security_group.cluster](https://registry.terraform.io/providers/exoscale/exoscale/latest/docs/resources/security_group) (resource)
- [exoscale_security_group_rule.cluster_client_rule](https://registry.terraform.io/providers/exoscale/exoscale/latest/docs/resources/security_group_rule) (resource)
- [exoscale_security_group_rule.cluster_rule](https://registry.terraform.io/providers/exoscale/exoscale/latest/docs/resources/security_group_rule) (resource)

## Required Inputs

The following input variables are required:

### <a name="input_cluster_name"></a> [cluster\_name](#input\_cluster\_name)

Description: The name of the cluster.

Type: `string`

### <a name="input_connection"></a> [connection](#input\_connection)

Description: Connection settings for the initial setup of the cluster.

Type:

```hcl
object({
    user        = string
    private_key = string
  })
```

### <a name="input_disk_size"></a> [disk\_size](#input\_disk\_size)

Description: Size of the root partition in GB. `10` should be sufficient for use with a bunch of small Kubernetes cluster.

Type: `number`

### <a name="input_hostnames"></a> [hostnames](#input\_hostnames)

Description: The list of hostnames that are cluster members. This variable also define how many members are set.

Type: `set(string)`

### <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type)

Description: Service offering of member instances. `standard.tiny` should be sufficient for use with a small Kubernetes cluster.

Type: `string`

### <a name="input_ssh_key"></a> [ssh\_key](#input\_ssh\_key)

Description: Authorized SSH key.

Type: `string`

### <a name="input_template_id"></a> [template\_id](#input\_template\_id)

Description: OS template id to use. Reference implementation is built using the `packer-exoscale` repository.

Type: `string`

### <a name="input_zone"></a> [zone](#input\_zone)

Description: Target zone of the infrastructure (e.g. 'ch-gva-2', 'ch-dk-2', 'de-fra-1', 'de-muc-1', etc.).

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_ipv4"></a> [ipv4](#input\_ipv4)

Description: If IPv4 must be enabled on member instances (can only be 'true' for now).

Type: `bool`

Default: `true`

### <a name="input_ipv6"></a> [ipv6](#input\_ipv6)

Description: If IPv6 must be enabled on member instances.

Type: `bool`

Default: `false`

### <a name="input_pki"></a> [pki](#input\_pki)

Description: How TLS is handled (valid `.mode` values: 'disabled', 'terraform').

Type:

```hcl
object({
    mode = string
  })
```

Default:

```json
{
  "mode": "terraform"
}
```

### <a name="input_preferred_link"></a> [preferred\_link](#input\_preferred\_link)

Description: The preferred link for communication inside of the cluster and with clients (valid values: 'public-ipv6', 'public-ipv4').

Type: `string`

Default: `"public-ipv6"`

### <a name="input_security_group_rules"></a> [security\_group\_rules](#input\_security\_group\_rules)

Description: A list of security groups to add. Clients of the cluster can be authorized using this variable.

Type:

```hcl
map(object({
    protocol = string
    type     = string
    port     = number
    source   = string
  }))
```

Default: `{}`

## Outputs

The following outputs are exported:

### <a name="output_ca_certificate_pem"></a> [ca\_certificate\_pem](#output\_ca\_certificate\_pem)

Description: The TLS certificate of the server.

### <a name="output_ca_private_key_pem"></a> [ca\_private\_key\_pem](#output\_ca\_private\_key\_pem)

Description: The private key of the server TLS certificate.

### <a name="output_instance_urls"></a> [instance\_urls](#output\_instance\_urls)

Description: A list of URLs to the cluster members. For use by cluster client.

### <a name="output_security_group"></a> [security\_group](#output\_security\_group)

Description: The cluster internal security group ID.
<!-- END_TF_DOCS -->